function surrogateCtor(){}function extend(a,b,c){surrogateCtor.prototype=a.prototype,b.prototype=new surrogateCtor,b.prototype.constructor=b,b.base=a;for(var d in c)b.prototype[d]=c[d];return b}UTIL="UTIL"in window?UTIL:{},"$"in window||($=function(a){var b=document.getElementById(a.replace("#","")),c=b.tagName.toUpperCase();return"CANVAS"==c||"AUDIO"==c?b=[b]:(b.empty=function(){return b.innerHTML="",b},b.append=function(a){return b.insertAdjacentHTML("beforeend",a),b},b.html=function(a){b.innerHTML=a}),b},$.getJSON=function(a,b){this.fail=function(){};var c=new XMLHttpRequest;return c.onreadystatechange=function(){c.readyState===XMLHttpRequest.DONE&&(200===c.status?b&&b(JSON.parse(c.responseText)):this.fail())},c.open("GET",a,!0),c.send(),{fail:function(a){this.fail=a}.bind(this)}}),UTIL.FullscreenSwitcher=function(a,b){var c=this;this.elementId=a,this.fullscreenToggleCallback=b,document.addEventListener("fullscreenchange",function(){c.fullscreenToggleCallback(!!document.fullscreen)},!1),document.addEventListener("mozfullscreenchange",function(){c.fullscreenToggleCallback(!!document.mozFullScreen)},!1),document.addEventListener("webkitfullscreenchange",function(){c.fullscreenToggleCallback(!!document.webkitIsFullScreen)},!1),document.onkeydown=function(a){if(122==a.keyCode)return this.toggleFullScreen(),a.keyCode=0,!1}.bind(this)},UTIL.FullscreenSwitcher.prototype={toggleFullScreen:function(){if(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{var a=document.getElementById(this.elementId);a.requestFullscreen?a.requestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}}},UTIL.Controls=function(a,b,c,d){this.observer=a,this.test=["ok"],this.absMode=d,this.reset(),null!=b&&new UTIL.FullscreenSwitcher(b,c),document.addEventListener("mousedown",this.onDocumentMouseDown.bind(this),!1),document.addEventListener("touchstart",this.onDocumentTouchStart.bind(this),!1),document.addEventListener("touchmove",this.onDocumentTouchMove.bind(this),!1),document.addEventListener("keypress",this.onDocumentKeyPress.bind(this),!1),document.addEventListener("keydown",this.onDocumentKeyDown.bind(this),!1),document.addEventListener("mousewheel",this.onDocumentMouseWheel.bind(this),!1),document.addEventListener("DOMMouseScroll",this.onDocumentMouseWheel.bind(this),!1)},UTIL.Controls.prototype={reset:function(){this.targetRotationX=0,this.targetRotationXOnMouseDown=0,this.targetRotationY=0,this.targetRotationYOnMouseDown=0,this.mouseX=0,this.mouseXOnMouseDown=0,this.mouseY=0,this.mouseYOnMouseDown=0,this.windowHalfX=window.innerWidth/2,this.windowHalfY=window.innerHeight/2},onDocumentMouseWheel:function(a){this.observer.preventDefault()&&a.preventDefault();var a=window.event||a,b=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail));return this.observer.mouseWheel(b),!1},onDocumentMouseDown:function(a){this.observer.preventDefault()&&a.preventDefault(),this.mmove=this.onDocumentMouseMove.bind(this),this.mup=this.onDocumentMouseUp.bind(this),this.mout=this.onDocumentMouseOut.bind(this),document.addEventListener("mousemove",this.mmove,!1),document.addEventListener("mouseup",this.mup,!1),document.addEventListener("mouseout",this.mout,!1),this.mouseXOnMouseDown=a.clientX-this.windowHalfX,this.targetRotationXOnMouseDown=this.absMode?0:this.targetRotationX,this.mouseYOnMouseDown=a.clientY-this.windowHalfY,this.targetRotationYOnMouseDown=this.absMode?0:this.targetRotationY},onDocumentMouseMove:function(a){this.mouseX=a.clientX-this.windowHalfX;var b=this.targetRotationX;this.targetRotationX=this.targetRotationXOnMouseDown+.02*(this.mouseX-this.mouseXOnMouseDown),this.mouseY=a.clientY-this.windowHalfY;var c=this.targetRotationY;this.targetRotationY=this.targetRotationYOnMouseDown+.02*(this.mouseY-this.mouseYOnMouseDown),this.observer.rotation(this.targetRotationX,this.targetRotationY,this.targetRotationX-b,this.targetRotationY-c,!1)},onDocumentMouseUp:function(a){document.removeEventListener("mousemove",this.mmove,!1),document.removeEventListener("mouseup",this.mup,!1),document.removeEventListener("mouseout",this.mout,!1),this.observer.rotation(this.targetRotationX,this.targetRotationY,0,0,!0)},onDocumentMouseOut:function(a){document.removeEventListener("mousemove",this.mmove,!1),document.removeEventListener("mouseup",this.mup,!1),document.removeEventListener("mouseout",this.mout,!1),this.observer.rotation(this.targetRotationX,this.targetRotationY,0,0,!0)},onDocumentTouchStart:function(a){1==a.touches.length&&(this.observer.preventDefault()&&a.preventDefault(),this.mouseXOnMouseDown=a.touches[0].pageX-this.windowHalfX,this.targetRotationXOnMouseDown=0,this.mouseYOnMouseDown=a.touches[0].pageY-this.windowHalfY,this.targetRotationYOnMouseDown=0,this.targetRotationY)},onDocumentTouchMove:function(a){if(1==a.touches.length){this.observer.preventDefault()&&a.preventDefault(),this.mouseX=a.touches[0].pageX-this.windowHalfX;var b=this.targetRotationX;this.targetRotationX=this.targetRotationXOnMouseDown+.05*(this.mouseX-this.mouseXOnMouseDown),this.mouseY=a.touches[0].pageY-this.windowHalfY;var c=this.targetRotationY;this.targetRotationY=this.targetRotationYOnMouseDown+.05*(this.mouseY-this.mouseYOnMouseDown),this.observer.rotation(this.targetRotationX,this.targetRotationY,this.targetRotationX-b,this.targetRotationY-c,!1)}},onDocumentKeyPress:function(a){var b=a.which;this.observer.keyPress(b,String.fromCharCode(b))},onDocumentKeyDown:function(a){var b=a.which;this.observer.keyDown(b,String.fromCharCode(b))}},UTIL.MP3Music=function(a,b){"string"==typeof a&&(a=[a]),this._readyCallback=b,this._gainNode=null,this._analyserNode=null,this._freqByteData=0,this._initMode=!0,this._mp3Loading=a.length,this._mp3Players=new Array(a.length),this._selectedSong=0;try{window.AudioContext=window.AudioContext||window.webkitAudioContext,this.context=new AudioContext}catch(a){alert("Web Audio API is not supported in this browser")}$("#isloading").empty().append('<div class="loading"><img src="./images/loading.gif"></div>'),this._loadMusic(a)},UTIL.MP3Music.prototype={setVolume:function(a){null!=this._gainNode&&(this._gainNode.gain.value=a)},getFrequencyData:function(){if(0===this._freqByteData){if(null==this._analyserNode)return null;this._freqByteData=new Uint8Array(this._analyserNode.frequencyBinCount)}return this._analyserNode.getByteFrequencyData(this._freqByteData),this._freqByteData},playTrack:function(a){this._mp3Players[this._selectedSong].pause(),this._selectedSong=a,this._mp3Players[this._selectedSong].autoplay=!0,this._mp3Players[this._selectedSong].play()},isPaused:function(){return!1},_handleLoaded:function(a){if(this._initMode){this._mp3Loading--;var b=this.context.createMediaElementSource(this._mp3Players[a]);b.loop=!0,b.connect(this._gainNode)}this._mp3Loading<=0&&(this._initMode=!1,$("#isloading").empty().append(" "),this._readyCallback())},_extraFuncScope:function(a,b){var c=document.createElement("audio");document.body.appendChild(c),this._mp3Players[b]=c,c.id=b,c.setAttribute("src",a),c.addEventListener("stalled",function(){}.bind(this)),c.addEventListener("canplay",function(){this._handleLoaded(b)}.bind(this)),c.addEventListener("emptied",function(){}.bind(this)),c.addEventListener("suspend",function(){}.bind(this)),c.addEventListener("ended",function(){c.setAttribute("src",a+"?ts="+(new Date).getTime()),c.load()}.bind(this)),c.load()},_loadMusic:function(a){this._gainNode=this.context.createGain(),this._analyserNode=this.context.createAnalyser(),this._gainNode.connect(this._analyserNode),this._analyserNode.connect(this.context.destination);for(var b=0;b<a.length;b++)this._extraFuncScope(a[b],b)}},UTIL.SoundDetector=function(a,b,c,d,e,f,g){this.lastDetect=0,this.repeatCount=0,this.trigger=a,this.repeats=b,this.repeatCount=0,this.invert=c,this.cooldown=d,this.stepWidth=e,this.startStep=f,this.maxSteps=g},UTIL.SoundDetector.prototype=Object.assign(Object.create(UTIL.SoundDetector.prototype),{constructor:UTIL.SoundDetector,detect:function(a){if(null==a||0==a.length)return!1;var b=new Date,c=b.getTime();if(c-this.lastDetect<=this.cooldown)return!1;for(var d=0,e=Math.floor(a.length/this.stepWidth),f=0,g=0;f<e;f++){if(f>=this.startStep){if(this.invert){if(a[d]>this.trigger)return!1}else if(a[d]<this.trigger)return!1;if(g+=1,this.maxSteps>0&&g>=this.maxSteps)break}d+=this.stepWidth}return this.repeatCount++>=this.repeats&&(this.lastDetect=c,this.repeatCount=0,!0)}}),UTIL.FpsStats=function(){this.sampleInterval=1e3,this.frames=0,this.prevTime=this.beginTime=0,this.fps=60},UTIL.FpsStats.prototype={begin:function(){this.beginTime=(performance||Date).now(),0==this.prevTime&&(this.prevTime=this.beginTime)},end:function(){this.frames++;var a=(performance||Date).now(),b=a-this.prevTime;b>this.sampleInterval&&(this.fps=this.frames*(b/1e3),this.prevTime=a,this.frames=0)},getFps:function(){return this.fps}},GEOMETRY={backupOriginalVertices:function(a){a.originalVertices=[];for(var b=0;b<a.vertices.length;b++){var c=new THREE.Vector3;c.set(a.vertices[b].x,a.vertices[b].y,a.vertices[b].z),a.originalVertices[b]=c}null!=a.boundingBox&&(a.originalBoundingBox=new THREE.Vector3(a.boundingBox.max.x-a.boundingBox.min.x,a.boundingBox.max.y-a.boundingBox.min.y,a.boundingBox.max.z-a.boundingBox.min.z))},moveTransformsToGeometry:function(a){a.updateMatrix(),a.geometry.applyMatrix(a.matrix),a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1),a.updateMatrix()}},UTIL="UTIL"in window?UTIL:{},UTIL.Text=function(a,b,c){this.selectedId=0,this.fontSize=22,this.charWidths=[],this.charLeadingSpaces=[],this.cfg=c,this.yOffset=-.3,this.TEXTPAGES=a,this.startFrame=-1,this.charTexture=this._getCharsetTexture();var d=this._createTextPageGeometries(this.charTexture.width,0);this.pageContainerMesh=this._createPageContainer(d,this.charTexture),b.add(this.pageContainerMesh)},UTIL.Text.prototype={resetScreenSize:function(a,b){this.cfg.width=a,this.cfg.height=b},setPosition:function(a,b,c){this.pageContainerMesh.position.x=a,this.pageContainerMesh.position.y=b,this.pageContainerMesh.position.z=c},replaceShader:function(a,b){var c=[UTIL.TextWobblerShader,UTIL.TextSideRollShader,UTIL.TextExplodeShader],d=a.material,e=new THREE.ShaderMaterial(c[b]);e.attributes=d.attributes,e.uniforms=d.uniforms,e.depthTest=d.depthTest,e.transparent=d.transparent,a.material=e},configureTextPage:function(a,b,c,d,e){e=void 0!==e?e:0,this.startFrame=a;var g;new THREE.Object3D;for(g=0;g<this.pageContainerMesh.children.length;g++){this.pageContainerMesh.children[g].visible=g==b}this.selectedId=b;var i=this.pageContainerMesh.children[b];null!=i&&(this.cfg.posX=c,this.cfg.posY=d,this.replaceShader(i,e))},_getCharsetTexture:function(){var a=document.createElement("canvas");a.width=256*this.fontSize,a.height=this.fontSize;var b=a.getContext("2d");b.font='bold 13pt "Mountains of Christmas"',b.fillStyle="white",b.strokeStyle="#010111",b.lineWidth=.5;for(var c=0;c<256;c++){var d=String.fromCharCode(c),e=b.measureText(d),f=e.width;this.charWidths.push(f);var g=Math.floor((this.fontSize-f)/2);this.charLeadingSpaces.push(g),b.strokeText(d,c*this.fontSize+g,this.yOffset*this.fontSize+this.fontSize),b.fillText(d,c*this.fontSize+g,this.yOffset*this.fontSize+this.fontSize)}var h=new THREE.Texture(a);return h.width=a.width,h.height=a.height,h.needsUpdate=!0,h.flipY=!1,h},_createTextPageGeometries:function(a,b){var d,c=[];for(d=0;d<this.TEXTPAGES.length;d++)c.push(this._createPageGeometry(this.TEXTPAGES[d],a,b));return c},_createPageGeometry:function(a,b,c){var d=new THREE.Geometry,e=2*a.length,f=new Float32Array(3*e*2),g=0,h=1,j=1,k=0;for(i=0;i<a.length;i++){var l=4*i,m=12*i,n=a.charCodeAt(i),o=this.charWidths[n],p=this.charLeadingSpaces[n],q=h/this.fontSize*(k-p);k+=o,d.vertices.push(new THREE.Vector3(q+c,g*j+c,0),new THREE.Vector3(q+h-c,g*j+c,0),new THREE.Vector3(q+h-c,g*j+j-c,0),new THREE.Vector3(q+c,g*j+j-c,0)),d.faces.push(new THREE.Face3(l+0,l+1,l+2)),d.faces.push(new THREE.Face3(l+0,l+2,l+3));var r=q+h/2,s=g*j+j/2;f[m+0]=r,f[m+1]=s,f[m+2]=r,f[m+3]=s,f[m+4]=r,f[m+5]=s,f[m+6]=r,f[m+7]=s,f[m+8]=r,f[m+9]=s,f[m+10]=r,f[m+11]=s;var t=n*this.fontSize/b,u=this.fontSize/b,v=0,w=1;d.faceVertexUvs[0].push([new THREE.Vector2(t,v+w),new THREE.Vector2(t+u,v+w),new THREE.Vector2(t+u,v)]),d.faceVertexUvs[0].push([new THREE.Vector2(t,v+w),new THREE.Vector2(t+u,v),new THREE.Vector2(t,v)]),10==n&&(g--,k=0)}var x=new THREE.BufferGeometry;return x.fromGeometry(d),x.addAttribute("charCenter",new THREE.BufferAttribute(f,2)),x},animate:function(a,b){var c=this.pageContainerMesh.children[this.selectedId];if(null!=c){this.pageContainerMesh.visible=!0;for(var d=0;d<this.pageContainerMesh.children.length;d++)this.pageContainerMesh.children[d].visible=d==this.selectedId;var e=c.material;e.uniforms.size.value=new THREE.Vector2(this.cfg.width,this.cfg.height);var f=(a-this.startFrame)/1e3;e.uniforms.effectAmount.value=(1-.95)/3,e.uniforms.map.value=this.charTexture,e.uniforms.time.value=f,e.uniforms.colorOverride.value=this.cfg.colorOverride,e.uniforms.zPos.value=this.cfg.zoom,e.uniforms.opacity.value=b,e.uniforms.xEff.value=this.cfg.xEff,e.uniforms.yEff.value=this.cfg.yEff,this.setPosition(this.cfg.posX,this.cfg.posY,this.cfg.posZ)}},_createPageContainer:function(a,b){var d,c=new THREE.Object3D;for(d=0;d<a.length;d++){var e=a[d],f=this._createWobbleEffectMaterial(e.attributes,b),g=new THREE.Mesh(e,f);g.visible=!1,c.add(g)}return c},_createWobbleEffectMaterial:function(a,b){var c=UTIL.TextWobblerShader,d=new THREE.ShaderMaterial(c);return d.side=THREE.DoubleSide,d.attributes=a,d.uniforms.size.value=new THREE.Vector2(this.cfg.width,this.cfg.height),d.uniforms.map.texture=b,d.depthTest=!1,d.transparent=!0,d}},UTIL.TextWobblerShader={uniforms:{tDiffuse:{type:"t",value:null},time:{type:"f",value:1},size:{type:"v2",value:null},map:{type:"t",value:1,texture:null},effectAmount:{type:"f",value:0},colorOverride:{type:"f",value:0},xEff:{type:"f",value:8},yEff:{type:"f",value:-4},xPos:{type:"f",value:-15},yPos:{type:"f",value:0},zPos:{type:"f",value:0},opacity:{type:"f",value:1}},vertexShader:["varying float vZ;","uniform float time;","uniform float xPos;","uniform float yPos;","uniform float zPos;","uniform float effectAmount;","varying vec2 vUv;","mat3 rotateAngleAxisMatrix(float angle, vec3 axis) {","float c = cos(angle);","float s = sin(angle);","float t = 1.0 - c;","axis = normalize(axis);","float x = axis.x, y = axis.y, z = axis.z;","return mat3(","t*x*x + c,    t*x*y + s*z,  t*x*z - s*y,","t*x*y - s*z,  t*y*y + c,    t*y*z + s*x,","t*x*z + s*y,  t*y*z - s*x,  t*z*z + c",");","}","vec3 rotateAngleAxis(float angle, vec3 axis, vec3 v) {","return rotateAngleAxisMatrix(angle, axis) * v;","}","void main() {","float eff= effectAmount;","float charSize= 1.0;","float idx = floor(position.y/charSize)*80.0 + floor(position.x/charSize);","vec3 corner = vec3(floor(position.x/charSize)*charSize, floor(position.y/charSize)*charSize, 0.0);","vec3 mid = corner + vec3(0.5, 0.5, 0.0);","vec3 rpos = rotateAngleAxis(idx+time, vec3(mod(idx,16.0), -8.0+mod(idx,15.0), 1.0), position - mid) + mid;","vec4 fpos = vec4( mix(position,rpos,eff), 1.0 );","fpos.x += xPos;","fpos.y += yPos+((cos(idx+time*2.0)))*4.2*eff;","fpos.z += zPos+ ((sin(idx+time*2.0)))*4.2*eff;","vec4 mvPosition = modelViewMatrix * fpos;","mvPosition.y += 4.0*sin(time*0.5+mvPosition.x/25.0)*eff;","mvPosition.x -= 4.0*cos(time*0.5+mvPosition.y/25.0)*eff;","vec4 p = projectionMatrix * mvPosition;","vUv = uv;","vZ = p.z;","gl_Position = p;","}"].join("\n"),fragmentShader:["precision highp float;","varying float vZ;","varying vec2 vUv;","uniform float time;","uniform float opacity;","uniform float effectAmount;","uniform float colorOverride;","uniform vec2 size;","uniform sampler2D map;","void main() {","vec2 d = gl_FragCoord.xy - (0.5+0.02*sin(time))*size*vec2(1.0, 1.0);","vec4 diffuse = texture2D(map, vUv);","diffuse.a = diffuse.a*opacity;","float a = sin(time*0.3)*2.0*3.14159;","d = vec2( d.x*cos(a) + d.y*sin(a),","         -d.x*sin(a) + d.y*cos(a));","vec2 rg = vec2(0.0)+abs(d)/(0.5*size);","float b = abs(vZ) / 540.0;","float o= effectAmount; if(colorOverride>0.0) o= colorOverride;","gl_FragColor = mix(diffuse, vec4(rg,b,diffuse.a),o);","}"].join("\n")},UTIL.TextSideRollShader={uniforms:{tDiffuse:{type:"t",value:null},time:{type:"f",value:1},size:{type:"v2",value:null},map:{type:"t",value:1,texture:null},effectAmount:{type:"f",value:0},colorOverride:{type:"f",value:0},xEff:{type:"f",value:8},yEff:{type:"f",value:-4},xPos:{type:"f",value:-15},yPos:{type:"f",value:0},zPos:{type:"f",value:0},opacity:{type:"f",value:1}},vertexShader:["attribute vec2 charCenter;","uniform float time;","uniform float xPos;","uniform float yPos;","uniform float zPos;","uniform float effectAmount;","varying vec2 vUv;","vec3 rotateAngle(float angle, vec3 v) {","\tfloat c = cos(angle);","\tfloat s = sin(angle);","\treturn mat3(","\t\tc,    -s,   0,","\t\ts,   c,    0,","\t\t0,  0 ,  1","\t\t)  * v;","}","void main() {","\tvec3 mid = vec3(charCenter.x, charCenter.y, 0.0);","\tfloat a= 60.0*cos(time*0.5)*effectAmount;","\tvec3 rpos = rotateAngle(-a, position - mid) + mid;","\tvec4 fpos = vec4( rpos, 1.0 );","\tfpos.x += xPos;","\tfpos.y += yPos;","\tfpos.z += zPos;","\tvec4 mvPosition = modelViewMatrix * fpos;","\tmvPosition.x -= 60.0*cos(time*0.5+mvPosition.y/25.0)*effectAmount;","\tvec4 p = projectionMatrix * mvPosition;","\tvUv = uv;","\tgl_Position = p;","}"].join("\n"),fragmentShader:["precision highp float;","varying vec2 vUv;","uniform float time;","uniform float opacity;","uniform float effectAmount;","uniform float colorOverride;","uniform vec2 size;","uniform sampler2D map;","void main() {","\tvec4 color = texture2D(map, vUv);","\tcolor.a = color.a*opacity;","\tgl_FragColor = color;","}"].join("\n")},UTIL.TextExplodeShader={uniforms:{tDiffuse:{type:"t",value:null},time:{type:"f",value:1},size:{type:"v2",value:null},map:{type:"t",value:1,texture:null},effectAmount:{type:"f",value:0},colorOverride:{type:"f",value:0},xEff:{type:"f",value:8},yEff:{type:"f",value:-4},xPos:{type:"f",value:-15},yPos:{type:"f",value:0},zPos:{type:"f",value:0},opacity:{type:"f",value:1}},vertexShader:["attribute vec2 charCenter;","varying float vZ;","uniform float time;","uniform float xEff;","uniform float yEff;","uniform float xPos;","uniform float yPos;","uniform float zPos;","uniform float effectAmount;","varying vec2 vUv;","vec3 rotateAngle(float angle, vec3 v) {","float c = cos(angle);","float s = sin(angle);","return mat3(","c,    -s,   0,","s,   c,    0,","0,  0 ,  1",")  * v;","}","void main() {","vec3 ref = vec3(charCenter.x, charCenter.y, 0.0);","vec3 origin= vec3(xEff, yEff, 0.0);","float radius= 170.0;","float affectedRadius= radius*effectAmount;","float frontDist= min(0.0, distance(ref, origin) - affectedRadius);","float f= -frontDist/affectedRadius;","float e= f*f*effectAmount*50.0;","vec3 dStep= normalize(ref-origin)/1.0*e;","vec3 po= vec3(position.x, position.y, position.z);","po = rotateAngle(e, po - ref) + ref;","po= po+dStep;","vec4 fpos = vec4( po, 1.0 );","fpos.x += xPos;","fpos.y += yPos;","fpos.z += zPos;","vUv = uv;","vZ = 0.0;","gl_Position = projectionMatrix * modelViewMatrix * fpos;","}"].join("\n"),fragmentShader:["precision highp float;","varying float vZ;","varying vec2 vUv;","uniform float time;","uniform float opacity;","uniform float effectAmount;","uniform float colorOverride;","uniform vec2 size;","uniform sampler2D map;","void main() {","vec2 d = gl_FragCoord.xy - (0.5+0.02*sin(time))*size*vec2(1.0, 1.0);","vec4 diffuse = texture2D(map, vUv);","diffuse.a = diffuse.a*opacity;","float a = sin(time*0.3)*2.0*3.14159;","d = vec2( d.x*cos(a) + d.y*sin(a),","         -d.x*sin(a) + d.y*cos(a));","vec2 rg = vec2(0.0)+abs(d)/(0.5*size);","float b = abs(vZ) / 540.0;","float o= effectAmount; if(colorOverride>0.0) o= colorOverride;","gl_FragColor = mix(diffuse, vec4(rg,b,(opacity*diffuse.a)),o);","}"].join("\n")},UTIL.MeshText=function(a,b){this._bevelEnabled=b,this._bevelThickness=0,this._bevelSize=.75,this._font=a,this._height=10,this._size=120,this._curveSegments=3},UTIL.MeshText.prototype={create:function(a){var b=new THREE.TextGeometry(a,{font:this._font,size:this._size,height:this._height,curveSegments:this._curveSegments,bevelThickness:this._bevelThickness,bevelSize:this._bevelSize,bevelEnabled:this._bevelEnabled,material:0,extrudeMaterial:1});if(b.computeBoundingBox(),b.computeVertexNormals(),!this._bevelEnabled)for(var c=this._height*this._size*.1,d=0;d<b.faces.length;d++){var e=b.faces[d];if(1==e.materialIndex){for(var f=0;f<e.vertexNormals.length;f++)e.vertexNormals[f].z=0,e.vertexNormals[f].normalize();var g=b.vertices[e.a],h=b.vertices[e.b],i=b.vertices[e.c],j=THREE.GeometryUtils.triangleArea(g,h,i);if(j>c)for(var f=0;f<e.vertexNormals.length;f++)e.vertexNormals[f].copy(e.normal)}}return b}},UTIL.getMeshTexter=function(a,b,c){c=void 0!==c&&c,(new THREE.FontLoader).load(a,function(a){this._font=a;var d=new UTIL.MeshText(a,c);b(d)})},UTIL.createText=function(a,b,c,d,e,f){var g=a.create(c),i=-.5*(g.boundingBox.max.x-g.boundingBox.min.x),j=new THREE.Mesh(g,b);return j.frustumCulled=!1,j.position.set(i,0,0),GEOMETRY.moveTransformsToGeometry(j),j.scale.x=j.scale.y=j.scale.z=d,j.rotation.x=THREE.Math.degToRad(e.x),j.rotation.y=THREE.Math.degToRad(e.y),j.rotation.z=THREE.Math.degToRad(e.z),GEOMETRY.moveTransformsToGeometry(j),j.rotation.z=THREE.Math.degToRad(60*Math.random()),j.position.set(f.x,f.y,f.z),GEOMETRY.moveTransformsToGeometry(j),GEOMETRY.backupOriginalVertices(g),j},EXTRUDER={createMeshes:function(a,b,c,d,e){for(var f=new Array,g=a.paths,h=a.amounts,j=(a.color,a.center),k=0;k<g.length;++k)for(var l=$d3g.transformSVGPath(g[k]),m=new THREE.Color(a.color[k]),n=new THREE.Color(a.emissive[k]),o=new THREE.MeshPhongMaterial({emissive:n,specular:16777215,color:m,shininess:10,side:THREE.DoubleSide}),p=h[k],q=0;q<l.length;++q){var r=l[q],s=new THREE.ExtrudeGeometry(r,{steps:1,amount:p,bevelEnabled:!0,bevelThickness:p/2,bevelSize:b*p/2,bevelSegments:4}),t=new THREE.Mesh(s,o),u=t.geometry;t.translateZ(-p-1),t.translateX(-j.x),t.translateY(-j.y),t.rotation.x=d.x,t.rotation.y=d.y,t.rotation.z=d.z,GEOMETRY.moveTransformsToGeometry(t),t.scale.x=t.scale.y=t.scale.z=c,t.position.set(e.x,e.y,e.z),GEOMETRY.moveTransformsToGeometry(t),GEOMETRY.backupOriginalVertices(u),f.push(t)}return f}},BOX2="BOX2"in window?BOX2:{},BOXMATH={FLT_EPSILON:1e-5,mat2quat:function(a,b){var c=new THREE.Quaternion,d=new THREE.Matrix4;d.set.apply(d,a),c.setFromRotationMatrix(d),c.toArray(b)},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},qnormalize:function(a){var b=new THREE.Quaternion(a[0],a[1],a[2],a[3]);b.normalize(),b.toArray(a)},quat2mat:function(a,b){var c=new THREE.Quaternion(a[0],a[1],a[2],a[3]),d=new THREE.Matrix4;d.makeRotationFromQuaternion(c),d.setPosition(new THREE.Vector3(b[12],b[13],b[14]));var e=new THREE.Matrix4;e.set.apply(e,d.elements),e.toArray(b)},quat2x:function(a,b){var c=Math.sqrt(2*(1-a[3]));b[0]=a[0]/c,b[1]=a[1]/c,b[2]=a[2]/c,b[3]=(1-a[3])/c},x2quat:function(a,b){var c=a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3];b[3]=(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]-a[3]*a[3])/c,b[0]=2*a[0]*a[3]/c,b[1]=2*a[1]*a[3]/c,b[2]=2*a[2]*a[3]/c,BOXMATH.qnormalize(b)}},Object.assign(BOX2,{RIGHT_OFFSET:0,UP_OFFSET:4,AHEAD_OFFSET:8,POS_OFFSET:12,splinedKeyFrames:function(a,b){for(var c=new Array,d=0;d<a.keyFrames.length;d++){var e=new BOX2.KeyFrame;e._init(a.keyFrames[d]),c.push(e)}var f=new Array;return(new BOX2.CatmullRom).spline(c,f,!0,b),f},getIqNoiseTexture:function(){for(var a=256,b=new Uint8Array(4*a*a),c=0;c<a*a;c++)b[4*c+0]=255*Math.random(),b[4*c+2]=255*Math.random();for(var d=0;d<a;d++)for(var e=0;e<a;e++){var f=256+e-37&255,g=256+d-17&255;b[4*(e+d*a)+1]=b[4*(f+g*a)+0],b[4*(e+d*a)+3]=b[4*(f+g*a)+2]}var h=new THREE.DataTexture(b,a,a,THREE.RGBAFormat,THREE.UnsignedByteType);return h.format=THREE.RGBAFormat,h.type=THREE.UnsignedByteType,h.generateMipmaps=!0,h.wrapS=h.wrapT=THREE.RepeatWrapping,h.minFilter=THREE.LinearMipMapLinearFilter,h.magFilter=THREE.LinearFilter,h.needsUpdate=!0,h},getGlobalNoiseTexture:function(){return BOX2.noisetexture="noisetexture"in BOX2?BOX2.noisetexture:BOX2.getIqNoiseTexture(256),BOX2.noisetexture},createCameraPath:function(a,b){for(var c=new THREE.LineBasicMaterial({color:16777215}),d=new THREE.Geometry,e=0;e<b.length;e++){var f=b[e],g=f.getPosition();d.vertices.push(new THREE.Vector3(g.x,g.y,g.z))}var h=new THREE.Line(d,c);h.frustumCulled=!1,a.add(h)},makeGLModelViewMatrix:function(a){var b=a.elements,c=new Float32Array(16);c[0]=b[BOX2.RIGHT_OFFSET+0],c[1]=b[BOX2.UP_OFFSET+0],c[2]=-b[BOX2.AHEAD_OFFSET+0],c[3]=b[BOX2.POS_OFFSET+0],c[4]=b[BOX2.RIGHT_OFFSET+1],c[5]=b[BOX2.UP_OFFSET+1],c[6]=-b[BOX2.AHEAD_OFFSET+1],c[7]=b[BOX2.POS_OFFSET+1],c[8]=b[BOX2.RIGHT_OFFSET+2],c[9]=b[BOX2.UP_OFFSET+2],c[10]=-b[BOX2.AHEAD_OFFSET+2],c[11]=b[BOX2.POS_OFFSET+2],c[12]=0,c[13]=0,c[14]=0,c[15]=1;var d=new THREE.Matrix4;return d.elements=c,d},removePosGLModelViewMatrix:function(a){var b=a.elements,c=new THREE.Vector3(b[3],b[7],b[11]);return b[3]=0,b[7]=0,b[11]=0,c}}),BOX2.KeyFrame=function(){this._delta_time=0,this._time=0,this._speed=0,this._v=new Float32Array(16),this._v.fill(0),this._q=new Float32Array(4),this._q.fill(0),this._x=new Float32Array(4),this._x.fill(0),this._isKey=!1,this._hackMatrix=!1},BOX2.KeyFrame.prototype={printPos:function(){return this._getMat(BOX2.POS_OFFSET+0)+" / "+this._getMat(BOX2.POS_OFFSET+1)+" / "+this._getMat(BOX2.POS_OFFSET+2)},copy:function(a){var b=new BOX2.KeyFrame;return b.delta_time=this._delta_time,b.time=this._time,b.speed=this._speed,b._v=this._v.slice(),b._q=this._q.slice(),b._x=this._x.slice(),b._isKey=this._isKey,b._hackMatrix=a,b},setHackMatrix:function(a){this._hackMatrix=a},getHackMatrix:function(){var a=new Float32Array(16);a[0]=-this._getMat(BOX2.RIGHT_OFFSET+0),a[1]=this._getMat(BOX2.UP_OFFSET+0),a[2]=-this._getMat(BOX2.AHEAD_OFFSET+0),a[3]=0,a[4]=-this._getMat(BOX2.RIGHT_OFFSET+1),a[5]=this._getMat(BOX2.UP_OFFSET+1),a[6]=-this._getMat(BOX2.AHEAD_OFFSET+1),a[7]=0,a[8]=-this._getMat(BOX2.RIGHT_OFFSET+2),a[9]=this._getMat(BOX2.UP_OFFSET+2),a[10]=-this._getMat(BOX2.AHEAD_OFFSET+2),a[11]=0,a[12]=this._getMat(BOX2.POS_OFFSET+0),a[13]=this._getMat(BOX2.POS_OFFSET+1),a[14]=this._getMat(BOX2.POS_OFFSET+2),a[15]=1;var b=new THREE.Matrix4;return b.elements=a,b},getShaderModelViewMatrix:function(){return this._v.slice()},getKeyFrameMatrix:function(){if(this.orthogonalize(),this._hackMatrix)return this.getHackMatrix();var a=new THREE.Matrix4;return a.elements=this.getShaderModelViewMatrix(),a},getPosition:function(){return new THREE.Vector3(this._v[BOX2.POS_OFFSET+0],this._v[BOX2.POS_OFFSET+1],this._v[BOX2.POS_OFFSET+2])},setKey:function(a){this._isKey=a},isKey:function(){return this._isKey},distanceTo:function(a){var b=[this._v[12]-a._v[12],this._v[13]-a._v[13],this._v[14]-a._v[14]];return Math.sqrt(BOXMATH.dot(b,b))},orthogonalize:function(){this._normalMat(BOX2.AHEAD_OFFSET)||(this._setMat(BOX2.AHEAD_OFFSET+0,0),this._setMat(BOX2.AHEAD_OFFSET+1,0),this._setMat(BOX2.AHEAD_OFFSET+2,1)),this._normalMat(BOX2.UP_OFFSET)||(this._setMat(BOX2.UP_OFFSET+2,0),1==Math.abs(this._getMat(BOX2.AHEAD_OFFSET+2))?(this._setMat(BOX2.UP_OFFSET+0,0),this._setMat(BOX2.UP_OFFSET+1,1)):(this._setMat(BOX2.UP_OFFSET+0,-this._getMat(BOX2.AHEAD_OFFSET+1)),this._setMat(BOX2.UP_OFFSET+1,this._getMat(BOX2.AHEAD_OFFSET+0)),this._normalMat(BOX2.UP_OFFSET)));for(var a=this._dotMat(BOX2.AHEAD_OFFSET,BOX2.UP_OFFSET),b=0;b<3;b++)this._addMat(BOX2.UP_OFFSET,-a*this._getMat(BOX2.AHEAD_OFFSET+b));for(var b=0;b<3;b++){var c=(b+1)%3,d=(b+2)%3;this._setMat(BOX2.RIGHT_OFFSET+b,this._getMat(BOX2.UP_OFFSET+c)*this._getMat(BOX2.AHEAD_OFFSET+d)-this._getMat(BOX2.UP_OFFSET+d)*this._getMat(BOX2.AHEAD_OFFSET+c))}this._setMat(BOX2.RIGHT_OFFSET+3,0),this._setMat(BOX2.UP_OFFSET+3,0),this._setMat(BOX2.AHEAD_OFFSET+3,0),this._setMat(BOX2.POS_OFFSET+3,1)},_init:function(a){this._time=a.time,this._delta_time=a.delta_time,this._speed=a.speed,this._v[BOX2.POS_OFFSET+0]=a.position[0],this._v[BOX2.POS_OFFSET+1]=a.position[1],this._v[BOX2.POS_OFFSET+2]=a.position[2],this._v[BOX2.AHEAD_OFFSET+0]=a.direction[0],this._v[BOX2.AHEAD_OFFSET+1]=a.direction[1],this._v[BOX2.AHEAD_OFFSET+2]=a.direction[2],this._v[BOX2.UP_OFFSET+0]=a.upDirection[0],this._v[BOX2.UP_OFFSET+1]=a.upDirection[1],this._v[BOX2.UP_OFFSET+2]=a.upDirection[2],BOXMATH.mat2quat(this._v,this._q)},_dotMat:function(a,b){return this._v[a+0]*this._v[b+0]+this._v[a+1]*this._v[b+1]+this._v[a+2]*this._v[b+2]},_normalMat:function(a){var b=this._dotMat(a,a);return!(Math.abs(b)<BOXMATH.FLT_EPSILON)&&(Math.abs(b-1)<BOXMATH.FLT_EPSILON||(b=1/Math.sqrt(b),this._v[a+0]*=b,this._v[a+1]*=b,this._v[a+2]*=b,!0))},_getMat:function(a){return this._v[a]},_setMat:function(a,b){this._v[a]=b},_addMat:function(a,b){this._v[a]+=b}},BOX2.CatmullRom=function(){},BOX2.CatmullRom.prototype={spline:function(a,b,c,d){if(b.length=0,!(a.length<2)){var e=a.slice(0,a.length),f=e.length;BOXMATH.mat2quat(e[0]._v,e[0]._q),BOXMATH.quat2x(e[0]._q,e[0]._x);for(var g=1;g<f;++g){BOXMATH.mat2quat(e[g]._v,e[g]._q);e[g-1]._q[0]*e[g]._q[0]+e[g-1]._q[1]*e[g]._q[1]+e[g-1]._q[2]*e[g]._q[2]+e[g-1]._q[3]*e[g]._q[3]<0&&(e[g]._q[0]*=-1,e[g]._q[1]*=-1,e[g]._q[2]*=-1,e[g]._q[3]*=-1),BOXMATH.quat2x(e[g]._q,e[g]._x)}c?(e.push(e[0]),0==e[e.length-1].delta_time&&this._suggestDeltaTime(e[e.length-1],a),e.push(e[1]),e.push(e[f-1])):(e.push(e[f-1]),e.push(e[f-1]),e.push(e[0])),f=e.length;var i=0;e[0].time=0;for(var g=1;g<f-1;++g)i+=e[g].delta_time,e[g].time=i;e[f-1].time=0;for(var g=0;g<f-3;++g)for(var j=e[g>0?g-1:f-1],k=e[g],l=e[g+1],m=e[g+2],n=0;n<d;++n){var o=new BOX2.KeyFrame;o.setKey(0==n);for(var p=n/d,q=0;q<4;++q)o._x[q]=this._catmull(p,j._x[q],k._x[q],l._x[q],m._x[q]);BOXMATH.x2quat(o._x,o._q),BOXMATH.qnormalize(o._q),BOXMATH.quat2mat(o._q,o._v);for(var q=12;q<15;++q){var r=j._v[q],s=k._v[q],t=l._v[q],u=m._v[q],v=.5*(t-s);r-=v,s-=v,t-=v,u-=v,o._v[q]=this._catmull(p,r,s,t,u),o._v[q]+=v}o.orthogonalize(),b.push(o)}}},_suggestDeltaTime:function(a,b){if(0==b.length)a.delta_time=0;else{var d=a.distanceTo(b[b.length-1]),e=d/a.speed;a.delta_time=e/30}},_catmull:function(a,b,c,d,e){return.5*(2*c+a*(-b+d+a*(2*b-5*c+4*d-e+a*(3*c-b-3*d+e))))}},BOX2.PKleinConfig=function(a,b){this._defines=a.join("\n"),this._dShape=b.join("\n")},BOX2.PKleinConfig.prototype={getDefines:function(){return this._defines},getDShape:function(){return this._dShape}},BOX2.ShadowSceneHolder=function(a,b){this._scene=new THREE.Scene;var c=new THREE.AmbientLight(3092271);this._scene.add(c);var d=new THREE.DirectionalLight(4210752,1.4);d.position=new THREE.Vector3(0,-1,0),this._scene.add(d),this._shadowCamera=this._createCamera(a,b)},BOX2.ShadowSceneHolder.prototype={getCamera:function(){return this._shadowCamera},getScene:function(){return this._scene},_createCamera:function(a,b){var c=39507e-8,d=Math.abs(c),e=65535*c,f=Math.tan(b*Math.PI/360)*d,g=Math.tan(a*Math.PI/360)*d,h=new THREE.PerspectiveCamera(b,g/f,d,e);return h.updateProjectionMatrix(),h},setAllInvisible:function(){for(var a=this._scene.children,b=0;b<a.length;b++){var c=a[b];"intensity"in c||(c.visible=!1)}},_syncShadowCamera:function(a){var b=BOX2.makeGLModelViewMatrix(a),c=BOX2.removePosGLModelViewMatrix(b),d=(new THREE.Matrix4).makeTranslation(-c.x,-c.y,-c.z);d.premultiply(b);for(var e=this._scene.children,f=0;f<e.length;f++){var g=e[f];g.matrixAutoUpdate=!1,g.matrix.copy(d)}}},BOX2.RawShaderSceneHolder=function(a,b,c,d,e){this._fov_x=b,this._fov_y=c,this._backgroundColor=d,this._scene=null,this._camera=null,this._mesh=null,this._material=null,this._initScene(),this._shadowScene=new BOX2.ShadowSceneHolder(this._fov_x,this._fov_y),this._materialsLib=this._createMaterials(a,e),this._precompileProgress=0;var f=Object.keys(this._materialsLib)[0];this._selectMaterial(f)},BOX2.RawShaderSceneHolder.prototype={getRandomMaterialKey:function(){var a=Object.keys(this._materialsLib);return 0==a.length?null:a[Math.round((a.length-1)*Math.random())]},getShadowRenderPass:function(){return new THREE.RenderPass(this._shadowScene.getScene(),this._shadowScene.getCamera())},getShadowScene:function(){return this._shadowScene.getScene()},configure:function(a,b){this._selectMaterial(a),this._updateScene(b),this._shadowScene.setAllInvisible()},getShaderPass:function(a,b){return new THREE.RenderPass(this._scene,this._camera)},getPrecompileSteps:function(){return Object.keys(this._materialsLib).length+1},incrementalPrecompile:function(a){for(var b=this._getRenderTarget(10,10),c=Object.keys(this._materialsLib),d=0;d<c.length;d++)if(this._selectMaterial(c[d]),d==this._precompileProgress)return a.render(this._scene,this._camera,b),this._precompileProgress++,!1;return a.render(this.getShadowScene(),this._shadowScene.getCamera(),b),!0},_selectMaterial:function(a){a=""+a,this._material=this._materialsLib[a],null==this._material&&console.log("error: no material for key: "+a),this._mesh.material=this._material},_updateScene:function(a){this._material.uniforms.time.value=(new Date).getTime(),this._setCameraToKeyFrame(a)},_createShaderMaterial:function(a){var b=this._getKleinianMaterial(this._backgroundColor,a);return b.uniforms.fov_x.value=this._fov_x,b.uniforms.fov_y.value=this._fov_y,b},_createMaterials:function(a,b){var c={};return Object.keys(b).forEach(function(d,e){var f=this._createShaderMaterial(b[d]);c[d]=this._precompileShaderMaterial(a,f)}.bind(this)),c},_applyMatrix:function(a,b){var c=new THREE.Vector3,d=new THREE.Quaternion,e=new THREE.Vector3;a.decompose(c,d,e),b.position.set(c.x,c.y,c.z),b.quaternion.set(d.x,d.y,d.z,d.w),b.scale=e,b.updateMatrix(),b.updateMatrixWorld(!0)},_setCameraToKeyFrame:function(a){var b=a.getKeyFrameMatrix();this._applyMatrix(b,this._mesh),this._shadowScene._syncShadowCamera(b)},_initScene:function(){this._scene=new THREE.Scene,this._camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this._mesh=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this._mesh.frustumCulled=!1,this._scene.add(this._mesh)},_precompileShaderMaterial:function(a,b){var c=console.warn;return console.warn=function(){},a.initMaterial(b,this._scene.fog,this._mesh),console.warn=c,b},_getRenderTarget:function(a,b){var c=new THREE.WebGLMultiRenderTarget(a,b);c.texSize=new THREE.Vector2(a,b),c.texture.format=THREE.RGBAFormat,c.texture.minFilter=THREE.LinearFilter,c.texture.magFilter=THREE.LinearFilter,c.texture.type=THREE.FloatType,c.texture.generateMipmaps=!1,c.stencilBuffer=!1,c.depthBuffer=!0;var d=c.texture.clone();return c.attachments.push(d),c.attachments[0].name="diffuse",c.attachments[1].name="scratchpad",c},_getKleinianMaterial:function(a,b){var e=(STD_DEFINES=b.getDefines(),D_SHAPE_FUNC=b.getDShape(),{uniforms:{mvMatrix:{type:"m4",value:new THREE.Matrix4},tNoise:{type:"t",value:null},speed:{type:"f",value:39507e-8},time:{type:"f",value:0},preset:{type:"i",value:0},fov_x:{type:"f",value:0},fov_y:{type:"f",value:0},backgroundColor:{type:"v3",value:null},min_dist:{type:"f",value:794328e-9},glow_strength:{type:"f",value:.499999},dist_to_color:{type:"f",value:.200951}},vertexShader:["#extension GL_EXT_draw_buffers : require","#extension GL_EXT_frag_depth : enable","precision highp float;","uniform float fov_x;","uniform float fov_y;","varying vec3 eye, dir;","float fov2scale(float fov) { return tan(radians(fov/2.0)); }","void main()\t{","  gl_Position = vec4(position, 1.0);","  eye = vec3(modelViewMatrix[3]);","  dir = vec3(modelViewMatrix * vec4( fov2scale(fov_x)*(position.x ), fov2scale(fov_y)*(position.y ), 1, 0));","}"].join("\n"),fragmentShader:["#extension GL_EXT_draw_buffers : require","#extension GL_EXT_frag_depth : enable","#ifdef GL_ES","precision highp float;","#endif","#define RIM_BLEEDING","#define DE_EPS 0.0001","#define MAX_DIST 10.0","#define MAX_STEPS 137","#define REFACTOR 0.5","#define TThickness 4.50741e-008","#define Ziter 3",`${STD_DEFINES}`,"#define OptionalJuliaSeed p=p;","#define DEfacScale k","#define BLEND 0.543","#define PI_HALF 1.5707963267948966192313216916398","#define ONE_PLUS_ULP 1.000000059604644775390625","#define ONE_MINUS_ULP 0.999999940395355224609375","#define ULP 0.000000059604644775390625","#define MIN_NORM 0.00001","#define AO_EPS\t\t0.0499998","#define AO_STRENGTH\t0.149624","varying vec3 eye, dir;","uniform vec3 backgroundColor;","uniform sampler2D tNoise;","uniform float speed;","uniform float min_dist;","uniform float glow_strength;","uniform float dist_to_color;","uniform float time;","uniform int preset;","vec3 specularColor = vec3(1.0, 0.8, 0.4),","  glowColor = vec3(0.03, 0.4, 0.4),","  aoColor = vec3(0, 0, 0);","const vec3 NORM_LIGHT=  normalize(vec3(1.0,0.5,0.7));",`${D_SHAPE_FUNC}`,"float d(vec3 p) {","\tfloat r2;","\tfloat DEfactor=1.;","\tfor(int i=0; i<ITERS; i++){","\t\tp=2.*clamp(p, -CSize, CSize)-p;","\t\tr2=dot(p,p);","\t\tfloat k=max(Size/r2, MAXI);","\t\tp*=k; DEfactor*= DEfacScale;","\t\tOptionalJuliaSeed","\t}","\treturn (DIST_MULTIPLIER*d_shape(p-Offset)/abs(DEfactor)-DEoffset);","}","vec3 color(vec3 p) {","\tfloat r2=dot(p,p);","\tfloat DEfactor=1.;","\tvec4  col=vec4(0.0);","\tfloat rmin=10000.0;;","\tvec3 Color= vec3(-1.072,5.067, 0.647 );","\tfor(int i=0; i<COLOR_ITERS; i++){","\t\tvec3 p1=2.*clamp(p, -CSize, CSize)-p;","\t\tcol.xyz+=abs(p-p1);","\t\tp=p1;","\t\tr2=dot(p,p);","\t\tfloat k=max(Size/r2, MAXI);","\t\tcol.w+=abs(k-1.);","\t\tp*=k; DEfactor*= DEfacScale;;","\t\tOptionalJuliaSeed","\t\tr2=dot(p,p);","\t\trmin=min(rmin,r2);","\t}","\treturn mix(vec3(sqrt(rmin)),(0.5+0.5*sin(col.z*Color)), BLEND);","}","vec3 generateNormal(vec3 pos, float d_pos) {","\tvec2 Eps = vec2(0, max(d_pos, MIN_NORM));","\treturn normalize(vec3(","\t\t-d(pos-Eps.yxx)+d(pos+Eps.yxx),","\t\t-d(pos-Eps.xyx)+d(pos+Eps.xyx),","\t\t-d(pos-Eps.xxy)+d(pos+Eps.xxy)","\t));","}","vec3 blinn_phong(vec3 normal, vec3 view, vec3 color) {","\tvec3 halfLV = normalize(NORM_LIGHT + view);","\tfloat diffuse= max( dot(normal, halfLV), 0.0 );","\tfloat specular = pow(diffuse, 32.0 );","#ifdef RIM_BLEEDING","\tdiffuse = dot(normal, NORM_LIGHT);","#endif","\treturn color * (diffuse * 0.5 + 0.75) + specular * specularColor;","}","float ambient_occlusion(vec3 p, vec3 n, float DistAtp, float side) {","\tfloat ao_ed= DistAtp*AO_EPS/min_dist;","\tfloat ao = 1.0, w = AO_STRENGTH/ao_ed;","\tfloat dist = 2.0 * ao_ed;","\tfor (int i=0; i<5; i++) {","\t\tfloat D = side * d(p + n*dist);","\t\tao -= (dist-D) * w;","\t\tw *= 0.5;","\t\tdist = dist*2.0 - ao_ed;","\t}","\treturn clamp(ao, 0.0, 1.0);","}","float march(inout vec3 p, in vec3 dp, inout float D, inout float totalD, in float side, in float MINDIST_MULT){","\tint steps= 0;","\tfor (int dummy=0; dummy<MAX_STEPS; dummy++) {","\t\ttotalD+=D;","\t\tD = (side * d(p + totalD * dp) - totalD * min_dist) * MINDIST_MULT;","\t\tsteps++;","\t\tif (!(abs(D)>max(totalD*8192.0*ULP,ULP) && totalD < MAX_DIST)) break;","\t}","\tp += (totalD+D) * dp;","\treturn float(steps);","}","float noise3d( in vec3 x ) {","    vec3 p = floor(x);","    vec3 f = fract(x);","\t f = f*f*(3.0-2.0*f);","\tvec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;","\tvec2 rg = texture2D( tNoise, (uv+0.5)/256.0, 0.0).yx;","\treturn mix( rg.x, rg.y, f.z );","}","void main() {","\tvec3 dp = normalize(dir);","\tfloat noise =  noise3d(vec3(gl_FragCoord.x, gl_FragCoord.y, gl_FragCoord.z));","\tvec3 p = eye;","\tfloat totalD = 0.0, D = d(p);","\tfloat side = sign(D);","\tD = noise * abs(D);","\tfloat MINDIST_MULT=1.0/(1.0+min_dist);","\tD *= MINDIST_MULT;","\tvec3 finalcol= vec3(0.);","\tfloat refpart= 1.0;","\tbool cont= true;","\tfloat firstD= 0.;","\tfor(int i= 0; i<REFITER; i++){","\t\tfloat steps= march(p, dp, D, totalD, side, MINDIST_MULT);","\t\tif (i == 0) { firstD= totalD + D; }","\t\tvec3 col= backgroundColor;","\t\tif (totalD < MAX_DIST) {","\t\t\tfloat D1= min_dist*.5*totalD;","\t\t\tvec3 n= side * generateNormal(p, max(256.0*ULP, D1));","\t\t\tcol= color(p);","\t\t\tcol= blinn_phong(n, -dp, col);","\t\t\tcol= mix(aoColor, col, ambient_occlusion(p, n, D1, side));","\t\t\tdp= reflect(dp,n);","\t\t\tp-= (totalD+D) * dp;","\t\t\tD= (9. + noise) * D1;","\t\t\tif (D > max(totalD*8192.0*ULP,ULP)){","\t\t\t\tfloat dc= clamp(log(D/min_dist) * dist_to_color, 0.0, 1.0);","\t\t\t\tcol= mix(col, backgroundColor, dc);","\t\t\t}","\t\t} else {","\t\t\tcont= false;","\t\t}","\t\tcol= mix(col, glowColor, (float(steps)+noise)/float(MAX_STEPS) * glow_strength);","\t\tfinalcol+= refpart*col;","\t\trefpart*= REFACTOR;","\t\tif (!cont) break;","\t}","\tfloat zNear= abs(speed);","\tfloat zFar= 65535.0 * zNear;","\tfloat a= zFar / (zFar - zNear);","\tfloat b= zFar * zNear / (zNear - zFar);","\tfloat l=  clamp(firstD/length(dir), zNear, zFar);","\tfloat depth= (a + b / l);","\tgl_FragDepthEXT= depth;","\tgl_FragData[1]= vec4(depth, 0.,0., 0.);","\tgl_FragData[0]= vec4(finalcol, 1.0);","}"].join("\n")}),f=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(e.uniforms),vertexShader:e.vertexShader,fragmentShader:e.fragmentShader});return f.uniforms.tNoise.value=BOX2.getGlobalNoiseTexture(),f.uniforms.backgroundColor.value=a,f}};